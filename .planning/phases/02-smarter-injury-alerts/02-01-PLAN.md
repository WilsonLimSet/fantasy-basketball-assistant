---
phase: 02-smarter-injury-alerts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/lib/smartAlerts.ts]
autonomous: true
---

<objective>
Add position-based injury alerts alongside existing star-based logic.

Purpose: User wants alerts when EITHER a high-usage star OR a same-position player gets injured (both affect fantasy value). Currently only star-based works.
Output: smartAlerts.ts that triggers on both position-based AND star-based teammate injuries.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/lib/smartAlerts.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add position-matching helper function</name>
  <files>src/lib/smartAlerts.ts</files>
  <action>
    Add a `sharesPosition()` function near the other helper functions (around line 50-60):

    ```typescript
    /**
     * Check if two players share a position (same minutes pool)
     * Examples: Both are C, both are PG, one is SG/SF and other is SF
     */
    function sharesPosition(player1: Player, player2: Player): boolean {
      // Check if any position overlaps
      return player1.positions.some(pos => player2.positions.includes(pos));
    }
    ```

    This enables position-based alerts (e.g., center goes out â†’ other centers benefit).
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>sharesPosition function exists and compiles</done>
</task>

<task type="auto">
  <name>Task 2: Add combined star/position check function</name>
  <files>src/lib/smartAlerts.ts</files>
  <action>
    Add a function that checks if a player change is impactful to another player:

    ```typescript
    /**
     * Check if changedPlayer's injury impacts beneficiary
     * Returns true if:
     * - changedPlayer is a high-usage star (affects whole team), OR
     * - changedPlayer shares position with beneficiary (competes for minutes)
     */
    function isImpactfulForPlayer(changedPlayer: Player, beneficiary: Player): boolean {
      // Star-based: high-usage players affect everyone on the team
      if (isHighUsageStar(changedPlayer)) return true;

      // Position-based: same-position players compete for minutes
      if (sharesPosition(changedPlayer, beneficiary)) return true;

      return false;
    }
    ```

    This combines both user requirements into one check.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>isImpactfulForPlayer function exists and handles both cases</done>
</task>

<task type="auto">
  <name>Task 3: Refactor teammate injury logic to use combined check</name>
  <files>src/lib/smartAlerts.ts</files>
  <action>
    Modify the teammate injury section (around lines 343-422) to:

    1. REMOVE the blanket star check that skips all non-stars:
       ```typescript
       // REMOVE THIS LINE:
       if (!isHighUsageStar(changedPlayer)) continue;
       ```

    2. Change the beneficiary filtering to use the new combined check:
       Instead of:
       ```typescript
       const affectedPlayers = playersWeCareAbout.get(changedPlayer.nbaTeamId) || [];
       const beneficiaries = affectedPlayers.filter(p => p.id !== changedPlayer.id);
       ```

       Change to:
       ```typescript
       const affectedPlayers = playersWeCareAbout.get(changedPlayer.nbaTeamId) || [];
       // Filter to players who are impacted by this change (star OR position)
       const beneficiaries = affectedPlayers.filter(p =>
         p.id !== changedPlayer.id && isImpactfulForPlayer(changedPlayer, p)
       );
       ```

    3. Update alert details to explain WHY the alert triggered:
       For injury alerts, indicate whether it's usage-based or position-based:
       ```typescript
       const reason = isHighUsageStar(changedPlayer)
         ? 'usage redistribution'
         : 'same position - more minutes';
       ```
       Include this in the details field.

    This makes alerts fire for BOTH star injuries (whole team benefits) AND position injuries (same-position players benefit).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
  </verify>
  <done>Teammate injury alerts trigger on both star-based AND position-based logic</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] `npx tsc --noEmit` passes
- [ ] Code has both position-based and star-based checks
- [ ] Alert details indicate why alert was triggered
</verification>

<success_criteria>
- sharesPosition() helper function added
- isImpactfulForPlayer() combines both checks
- Teammate injury alerts fire for BOTH star injuries AND position injuries
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-smarter-injury-alerts/02-01-SUMMARY.md`
</output>
