---
phase: 04-cleanup-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/app/api/refresh/route.ts, README.md]
autonomous: true
---

<objective>
Simplify cron authentication and fix threshold documentation inconsistency.

Purpose: Remove unnecessary complexity (weak auth fallback) and fix confusing documentation (code says 25, README says 38).
Output: Cleaner auth logic, consistent documentation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/app/api/refresh/route.ts
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Simplify cron authentication</name>
  <files>src/app/api/refresh/route.ts</files>
  <action>
    Simplify the auth logic (lines 33-45). For a single-user app, we don't need the User-Agent fallback hack.

    Replace this block:
    ```typescript
    // Check for authorization (for cron jobs, Vercel sends a special header)
    const authHeader = request.headers.get('authorization');
    const cronSecret = process.env.CRON_SECRET;
    const isManualRefresh = request.headers.get('x-manual-refresh') === 'true';

    // In production, verify cron secret for automated calls
    if (cronSecret && !isManualRefresh && authHeader !== `Bearer ${cronSecret}`) {
      // Allow if no auth header and it's likely a browser request
      const userAgent = request.headers.get('user-agent') || '';
      if (!userAgent.includes('Mozilla') && !userAgent.includes('Chrome')) {
        return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
      }
    }
    ```

    With simpler logic:
    ```typescript
    // Simple auth: allow manual refresh, cron with secret, or no secret configured
    const authHeader = request.headers.get('authorization');
    const cronSecret = process.env.CRON_SECRET;
    const isManualRefresh = request.headers.get('x-manual-refresh') === 'true';

    // Only enforce auth if CRON_SECRET is set and this isn't a manual refresh
    if (cronSecret && !isManualRefresh && authHeader !== `Bearer ${cronSecret}`) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }
    ```

    This removes the weak User-Agent fallback. Auth is now:
    - Manual refresh (x-manual-refresh header) → always allowed
    - CRON_SECRET not set → always allowed (dev mode)
    - CRON_SECRET set → require Bearer token
  </action>
  <verify>
    - `npm run build` succeeds
    - No User-Agent check remains in refresh route
  </verify>
  <done>Auth logic simplified, no weak fallback</done>
</task>

<task type="auto">
  <name>Task 2: Fix threshold documentation in README</name>
  <files>README.md</files>
  <action>
    Find the line that says "38+ projected fantasy points" and update it to match the code (25 pts).

    The README says:
    ```
    We only alert on **high-usage stars** (38+ projected fantasy points).
    ```

    Change to:
    ```
    We only alert on **high-usage stars** (25+ projected fantasy points).
    ```

    This matches the actual `STAR_THRESHOLD = 25` in smartAlerts.ts.

    Note: 25 pts is the correct threshold for "starter-level players whose absence redistributes usage". 38 was too high and would miss important players.
  </action>
  <verify>
    - `grep "25+" README.md` shows the updated threshold
    - No reference to 38+ remains for star threshold
  </verify>
  <done>README matches code: 25+ pts threshold</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] No User-Agent auth fallback in refresh route
- [ ] README says 25+ pts (matches STAR_THRESHOLD in code)
- [ ] Auth logic is cleaner and more secure
</verification>

<success_criteria>
- Cron auth simplified (no weak User-Agent fallback)
- README threshold matches code (25 pts)
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-cleanup-polish/04-01-SUMMARY.md`
</output>
